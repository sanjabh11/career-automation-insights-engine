# PBI-0001-7 SERP API Key Standardization

**Back to Task Index**: [Tasks for PBI PBI-0001](./tasks.md)

## Description
Standardize all SerpAPI usages to prefer `SERPAPI_API_KEY` with a temporary fallback to `SERPAPI_KEY`, logging a warning when falling back. Centralize SerpAPI requests via a shared helper to remove duplicate key handling.

## Status History
- 2025-08-11 | Proposed -> InProgress | Standardization approach defined; code updates started
- 2025-08-11 | InProgress -> Review | `SerpApiClient` helper added; `serpapi-jobs` and `course-search` refactored

## Requirements
- Prefer `SERPAPI_API_KEY` everywhere; `SERPAPI_KEY` only as a logged fallback.
- No direct env reads for SerpAPI inside functions where helper is used.
- Add a shared `serpApiSearch(params)` to `supabase/lib/SerpApiClient.ts`.
- Update affected functions to use the helper (jobs, course search, others if present).

## Implementation Plan
- Add `serpApiSearch(params)` to `supabase/lib/SerpApiClient.ts` with warning when using fallback.
- Refactor `supabase/functions/serpapi-jobs/index.ts` to use the helper.
- Refactor `supabase/functions/course-search/index.ts` to use the helper.
- Targeted search for `SERPAPI_KEY` in `supabase/` and migrate any remaining usages.

## Test Plan
- Unit (light): mock fetch and assert helper builds correct URL with `api_key`.
- Integration: call each Edge Function with a sample query and check 200 + payload shape.
- Config test: run with only `SERPAPI_KEY` set and verify warning is printed and function still works.

## Verification
- All SerpAPI requests originate from the helper; no direct URL constructions with `api_key` in functions.
- Warnings are emitted only when falling back.
- Successful responses with both primary and fallback env configurations.

## Files Modified
- supabase/lib/SerpApiClient.ts (added helper, warnings)
- supabase/functions/serpapi-jobs/index.ts (refactored)
- supabase/functions/course-search/index.ts (refactored)
