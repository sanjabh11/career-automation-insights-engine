# 0001-14 Hardening calculate-apo: validation, rate limiting, API key, CORS

## Description
Add input validation, per-IP rate limiting, optional API-key enforcement, and strict CORS for `calculate-apo` to improve reliability and security before cloud deployment.

## Status History
- 2025-08-23 start_work: Proposed -> InProgress (Cascade)

## Requirements
- Validate request body with Zod (occupation.code, occupation.title required)
- Enforce optional header `x-api-key` if `APO_FUNCTION_API_KEY` is set
- Rate limit per IP per minute (default 30; env `APO_RATE_LIMIT_PER_MIN`)
- Expose rate limit headers and allow `x-api-key` via CORS

## Implementation Plan
- Update `supabase/functions/calculate-apo/index.ts`:
  - Add `RequestSchema`
  - Import and apply `rateLimit` from `supabase/lib/RateLimiter.ts`
  - Enforce `APO_FUNCTION_API_KEY` if present
  - Normalize `weightsUsed` after merging DB config
  - Extend CORS headers

## Test Plan
- Unit: parse/validate body; missing fields -> 500 (JSON schema error)
- Integration: send requests over limit -> 429 with rate headers
- Security: set `APO_FUNCTION_API_KEY` and test 401 without/with wrong key; 200 with correct key
- CORS: preflight OPTIONS should include new headers

## Verification
- Manual curl tests in staging (Supabase Cloud) with and without API key; verify rate headers

## Files Modified
- `supabase/functions/calculate-apo/index.ts`
- `supabase/lib/RateLimiter.ts` (used)
