# 0001-13 T5: Prompt upgrades for APO reliability

## Description
Refine the Gemini system prompt to reduce hallucinations and improve determinism:
- Reinforce JSON-only output (no code fences, no prose).
- Add compact, valid example JSON.
- Clarify numeric types (no stringified numbers, no trailing commas).
- Emphasize category APO must reflect item-weighted means and that model should adjust items if misaligned.

## Status History
- 2025-08-12T14:31:12+05:30: user_approves (Proposed -> Agreed) by User
- 2025-08-12T14:31:12+05:30: start_work (Agreed -> InProgress) by AI_Agent

## Requirements
- Update the in-function prompt in `supabase/functions/calculate-apo/index.ts`.
- Keep few-shot hints but ensure the output remains strictly to schema.
- Ensure token budget is reasonable (≤ 2k output tokens).

## Implementation Plan
- Insert an explicit example JSON object matching the schema, minimal but valid.
- Add “do not wrap with code fences” and “no extra keys” constraints.
- Clarify item-first then aggregate, reconcile contradictions by adjusting items.

## Test Plan
- Trigger APO with multiple roles; verify JSON parses without fallback and schema validation passes.

## Files Modified
- `supabase/functions/calculate-apo/index.ts`
