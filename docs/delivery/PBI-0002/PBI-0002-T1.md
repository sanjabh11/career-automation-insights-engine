# PBI-0002-T1 Build `/ai-career-coach` Supabase Edge Function

## Description
Create a Deno-based Supabase Edge Function that exposes the `/ai-career-coach` endpoint. The function will wrap requests to Google Gemini 2.5 Flash, enforce a strict JSON schema for input/output, cache short-lived context, and log each interaction in the `llm_logs` table.

## Status History
| Timestamp | Event | From | To | Details | User |
|-----------|-------|------|----|---------|------|
| 2025-08-07 | user_approves | Proposed | Agreed | Task created & approved. | User |

## Requirements
1. **Endpoint**: `POST /ai-career-coach` (Edge Function route).
2. **Input Schema** (Zod):
   ```json
   {
     "message": "string (1-2000 chars)",
     "conversationHistory": "array of previous messages [{role, content}] (max 20)",
     "userProfile": {"id":"uuid","occupationCode":"string","careerGoals":"string", ...}
   }
   ```
3. **Output Schema**:
   ```json
   {
     "response": "string",
     "followUpQuestions": ["string"],
     "actionItems": ["string"],
     "usage": {"promptTokens": int, "completionTokens": int}
   }
   ```
4. **Security**: Never expose Gemini API key; call from backend only.
5. **Logging**: Insert each interaction into `llm_logs` with request/response size, timing, and user id.
6. **Unit Tests**: Validate schema, error handling, and logging via Supabase emulator.

## Implementation Plan
1. Scaffold function in `supabase/functions/ai-career-coach/index.ts`.
2. Add Zod schemas for request/response.
3. Build `GeminiClient` wrapper (importable for other functions).
4. Implement caching of last 5 messages in KV (Supabase Deno KV).
5. Insert log row in `llm_logs`.
6. Write unit tests in `/supabase/tests/ai-career-coach.test.ts`.
7. Update workflow to run `supabase functions deploy ai-career-coach` on merge.

## Test Plan
- **Unit**: Mock Gemini API; validate 200 on valid input, 400 on schema violation, 500 on external error.
- **Integration**: Deploy to Supabase staging; hit endpoint with sample payload; verify DB row.
- **Load**: 50 concurrent requests <= 3 s avg.

## Verification
- All tests green in CI.
- Manual QA via Swagger / Postman.
- Confirm log row exists in `llm_logs`.

## Files Modified / Added
- `supabase/functions/ai-career-coach/index.ts`
- `supabase/lib/GeminiClient.ts`
- `supabase/tests/ai-career-coach.test.ts`
- CI workflow update
